name: Crowdin Upload Action (on changes)

on:
  push:
    paths: ['translations/azt.pot']
    branches: [ main ]

jobs:
  crowdin-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Install gettext tools
        run: sudo apt-get update && sudo apt-get install -y gettext

      - name: Generate translations.pot
        id: extract
        run: |
          set -euo pipefail

          OUT="translations/azt.pot"
          mkdir -p "$(dirname "$OUT")"
          TMPDIR="$(mktemp -d)"
          declare -a POTS=()

          # Helper to run xgettext on a list of files (null-delimited)
          run_xgettext() {
            lang="$1"; shift
            out="$1"; shift
            opts=("$@")
            if [ -t 0 ]; then
              return 1
            fi
            xargs -0 xgettext -L "$lang" "${opts[@]}" --from-code=UTF-8 -o "$out"
          }

          # Only look for the _(...) marker

          # Python
          if git grep -q -I -E "_\(" -- '*.py'; then
            git grep -l -I -z -E "_\(" -- '*.py' | run_xgettext "Python" "$TMPDIR/python.pot" -k_
            POTS+=("$TMPDIR/python.pot")
          fi

          # JavaScript / TypeScript / JSX / TSX / Vue
          if git grep -q -I -E "_\(" -- '*.js' '*.jsx' '*.ts' '*.tsx' '*.vue'; then
            git grep -l -I -z -E "_\(" -- '*.js' '*.jsx' '*.ts' '*.tsx' '*.vue' | run_xgettext "JavaScript" "$TMPDIR/js.pot" -k_ --language=JavaScript
            POTS+=("$TMPDIR/js.pot")
          fi

          # PHP
          if git grep -q -I -E "_\(" -- '*.php'; then
            git grep -l -I -z -E "_\(" -- '*.php' | run_xgettext "PHP" "$TMPDIR/php.pot" -k_
            POTS+=("$TMPDIR/php.pot")
          fi

          # If no source POTs created, create an empty POT placeholder
          if [ "${#POTS[@]}" -eq 0 ]; then
            echo "# No translatable strings detected." > "$OUT"
            echo "created=empty" >> "$OUT"
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Merge all POT fragments into the final translations file
          msgcat --use-first --sort-output --no-wrap -o "$OUT" "${POTS[@]}"

          # Normalize POT-Creation-Date to reduce spurious diffs
          if grep -q '^"POT-Creation-Date:' "$OUT"; then
            sed -i 's/^"POT-Creation-Date:.*$/"POT-Creation-Date: 1970-01-01 00:00+0000\\n"/' "$OUT" || true
          fi

          echo "Generated $OUT (size: $(wc -c < "$OUT") bytes)"
          echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push translations.pot if it changed
        if: steps.extract.outputs.changed == 'true'
        env:
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"

          # Compare the generated file and commit if different
          if git diff --no-ext-diff --exit-code --quiet -- translations/azt.pot; then
            echo "No changes to translations/azt.pot â€” nothing to commit."
            exit 0
          fi

          git add translations/azt.pot
          git commit -m "Update translations/azt.pot [skip ci]"
          git push origin HEAD
        
      - name: Done
        run: echo "translations/azt.pot update job finished."

      - name: Crowdin push
        uses: crowdin/github-action@v2
        with:
          upload_sources: true
          upload_translations: true
          download_translations: false
        env:
          CROWDIN_PROJECT_ID: ${{ secrets.CROWDIN_PROJECT_ID }}
          CROWDIN_PERSONAL_TOKEN: ${{ secrets.CROWDIN_PERSONAL_TOKEN }}
